name: Install openDAQ framework package

inputs:
  framework-filename:
    required: true
    description: Full path to the openDAQ framework package file

runs:
  using: composite

  steps:
    - name: Convert path for Windows
      if: runner.os == 'Windows'
      id: windows-path
      shell: bash
      run: |
        # Convert Unix-style path to Windows-style
        windowsPath=$(cygpath -w "${{ inputs.framework-filename }}")
        echo "path=$windowsPath" >> $GITHUB_OUTPUT

    - name: Install openDAQ framework package (Windows)
      if: runner.os == 'Windows'
      shell: pwsh
      run: |
        $packagePath = "${{ steps.windows-path.outputs.path }}"
        Write-Host "Installing from: $packagePath"

        $process = Start-Process -FilePath $packagePath -ArgumentList "/S" -Wait -NoNewWindow -PassThru
        if ($process.ExitCode -eq 0) {
            Write-Host "OpenDAQ installed successfully, updating PATH..."
            $openDAQBin = "C:\Program Files\openDAQ\bin"
            Add-Content -Path $env:GITHUB_ENV -Value "PATH=$openDAQBin`;$env:PATH"
            Write-Host $env:PATH
        }
        else {
            Write-Host "OpenDAQ installation failed with exit code $($process.ExitCode)"
            exit $process.ExitCode
        }

    - name: Install openDAQ framework package (Linux)
      if: runner.os == 'Linux'
      shell: bash
      run: sudo dpkg -i "${{ inputs.framework-filename }}"

    - name: Unsupported runner OS
      if: runner.os != 'Windows' && runner.os != 'Linux'
      shell: bash
      run: |
        echo "Install openDAQ is not supported for ${{ runner.os }}"
        exit 1
